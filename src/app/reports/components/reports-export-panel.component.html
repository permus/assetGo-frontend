<div *ngIf="isOpen" class="export-panel-overlay">
  <div class="export-panel">
    <div class="panel-header">
      <h3 class="panel-title">
        <svg class="panel-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7,10 12,15 17,10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Export Reports
      </h3>
      <button class="close-button" (click)="onClose()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="panel-content">
      <!-- Export Options -->
      <div class="export-options" *ngIf="activeExports.length === 0">
        <div class="option-group">
          <span class="option-label">Export Format</span>
          <div class="format-options">
            <label class="format-option" *ngFor="let fmt of exportFormats">
              <input class="format-radio" type="radio" name="format" [value]="fmt.value" [(ngModel)]="selectedFormat">
              <div class="format-content">
                <svg class="format-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7,10 12,15 17,10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <div class="format-info">
                  <span class="format-name">{{ fmt.label }}</span>
                  <span class="format-description">{{ fmt.description }}</span>
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="option-group">
          <span class="option-label">Options</span>
          <div class="parameter-options">
            <label class="parameter-option">
              <input class="parameter-checkbox" type="checkbox" [(ngModel)]="includeCharts"> <span class="parameter-text">Include charts</span>
            </label>
            <label class="parameter-option">
              <input class="parameter-checkbox" type="checkbox" [(ngModel)]="includeKPIs"> <span class="parameter-text">Include KPIs</span>
            </label>
            <label class="parameter-option">
              <input class="parameter-checkbox" type="checkbox" [(ngModel)]="includeFilters"> <span class="parameter-text">Include filters</span>
            </label>
          </div>
        </div>

        <div class="option-group">
          <span class="option-label">Filename</span>
          <input class="filename-input" type="text" [(ngModel)]="filename" placeholder="Optional filename...">
          <div class="filename-preview">{{ getFilenamePreview() }}</div>
        </div>

      </div>

      <!-- Active Exports -->
      <div class="active-exports" *ngIf="activeExports.length">
        <div class="export-header">
          <h4>Export Progress</h4>
          <div class="debug-buttons">
            <button type="button" class="toolbar-button" (click)="refreshExports()">Refresh</button>
            <button type="button" class="toolbar-button" (click)="forceStopAllPolling()">Stop Polling</button>
            <button type="button" class="toolbar-button" (click)="clearExports()">Clear</button>
          </div>
        </div>

        <div class="exports-list">
          <div class="export-item" *ngFor="let exportRun of activeExports; trackBy: trackByRunId">
            <div class="export-info">
              <div class="row-header">
                <span class="export-name">{{ getReportDisplayName(exportRun.report_key || 'Unknown') }}</span>
                <span class="export-format">{{ exportRun.format?.toUpperCase() || 'N/A' }}</span>
              </div>

              <div class="export-status">
                <span class="status-badge" [ngClass]="'status-' + (exportRun.status || 'unknown')">
                  {{ exportRun.status_label || 'Unknown' }}
                </span>
                <span class="execution-time" *ngIf="exportRun.execution_time_formatted">{{ exportRun.execution_time_formatted }}</span>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" *ngIf="exportRun.status === 'queued' || exportRun.status === 'running'">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getProgress(exportRun)"></div>
              </div>
              <span class="progress-text">{{ getProgress(exportRun) }}%</span>
            </div>

            <!-- Actions -->
            <div class="export-actions">
              <button class="action-button download-button" *ngIf="exportRun.status === 'success'" (click)="onDownload(exportRun)" [disabled]="!exportRun.download_url">Download</button>
              <button class="action-button cancel-button" *ngIf="exportRun.status === 'queued' || exportRun.status === 'running'" (click)="onCancel(exportRun)">Cancel</button>
              <button class="action-button retry-button" *ngIf="exportRun.status === 'failed'" (click)="onRetry(exportRun)">Retry</button>
            </div>

            <!-- File Info -->
            <div class="file-info" *ngIf="exportRun.status === 'success' && exportRun.file_size">
              <span class="file-size">{{ formatFileSize(exportRun.file_size) }}</span>
              <span class="row-count" *ngIf="exportRun.row_count">{{ exportRun.row_count }} rows</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Export History (placeholder) -->
      <div class="export-history" *ngIf="showHistory">
        <h4>Recent Exports</h4>
        <div class="history-list">
          <div class="export-item" *ngFor="let exportRun of activeExports">
            <div class="export-info">
              <div class="export-title">
                <span class="report-name">{{ getReportDisplayName(exportRun.report_key || 'Unknown') }}</span>
                <span class="export-format">{{ exportRun.format?.toUpperCase() || 'N/A' }}</span>
              </div>
              <div class="export-status">
                <span class="status-badge" [ngClass]="'status-' + (exportRun.status || 'unknown')">
                  {{ exportRun.status_label || 'Unknown' }}
                </span>
                <span class="execution-time" *ngIf="exportRun.execution_time_formatted">
                  {{ exportRun.execution_time_formatted }}
                </span>
              </div>
            </div>
            <div class="export-actions">
              <button class="action-button download-button" *ngIf="exportRun.status === 'success'" (click)="onDownload(exportRun)">
                Download
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="panel-footer">
      <button class="footer-button" (click)="onClose()">Close</button>
      <button class="footer-button" (click)="onViewHistory()" *ngIf="!showHistory">Recent Exports</button>
      <button class="footer-button export-button" (click)="onExport()" [disabled]="isExporting">
        <svg class="button-icon" [class.spinning]="isExporting" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7,10 12,15 17,10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        {{ isExporting ? 'Exportingâ€¦' : 'Export' }}
      </button>
    </div>
  </div>
</div>
