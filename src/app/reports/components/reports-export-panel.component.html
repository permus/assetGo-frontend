<div class="export-panel" *ngIf="isOpen">
  <div class="export-panel-overlay" (click)="onClose()"></div>
  
  <div class="export-panel-content">
    <div class="export-panel-header">
      <h3>Export Reports</h3>
      <button class="close-button" (click)="onClose()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="export-panel-body">
      <!-- Export Options -->
      <div class="export-options" *ngIf="activeExports.length === 0">
        <div class="format-selection">
          <label>Export Format:</label>
          <select [(ngModel)]="selectedFormat" class="format-select">
            <option value="pdf">PDF</option>
            <option value="xlsx">Excel (XLSX)</option>
            <option value="csv">CSV</option>
            <option value="json">JSON</option>
          </select>
        </div>

        <div class="export-actions">
          <button class="export-button" (click)="onExport()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7,10 12,15 17,10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export Selected Reports
          </button>
        </div>
      </div>

      <!-- Active Exports -->
      <div class="active-exports" *ngIf="activeExports.length">
        <div class="export-header">
          <h4>Export Progress</h4>
          <div class="debug-buttons">
            <button type="button" class="btn btn-sm btn-outline-secondary" (click)="refreshExports()">
              Refresh
            </button>
            <button type="button" class="btn btn-sm btn-outline-warning" (click)="forceStopAllPolling()">
              Stop Polling
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" (click)="clearExports()">
              Clear
            </button>
          </div>
        </div>
        
        <div class="export-item" *ngFor="let exportRun of activeExports; trackBy: trackByRunId">
          <div class="export-info">
            <div class="export-title">
              <span class="report-name">{{ getReportDisplayName(exportRun.report_key || 'Unknown') }}</span>
              <span class="export-format">{{ exportRun.format?.toUpperCase() || 'N/A' }}</span>
            </div>
            
            <div class="export-status">
              <span class="status-badge" [ngClass]="'status-' + (exportRun.status || 'unknown')">
                {{ exportRun.status_label || 'Unknown' }}
              </span>
              <span class="execution-time" *ngIf="exportRun.execution_time_formatted">
                {{ exportRun.execution_time_formatted }}
              </span>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="progress-container" *ngIf="exportRun.status === 'queued' || exportRun.status === 'running'">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getProgress(exportRun)"></div>
            </div>
            <span class="progress-text">{{ getProgress(exportRun) }}%</span>
          </div>

          <!-- Actions -->
          <div class="export-actions">
            <button 
              class="action-button download-button" 
              *ngIf="exportRun.status === 'success'"
              (click)="onDownload(exportRun)"
              [disabled]="!exportRun.download_url">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Download
            </button>

            <button 
              class="action-button cancel-button" 
              *ngIf="exportRun.status === 'queued' || exportRun.status === 'running'"
              (click)="onCancel(exportRun)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
              Cancel
            </button>

            <button 
              class="action-button retry-button" 
              *ngIf="exportRun.status === 'failed'"
              (click)="onRetry(exportRun)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23,4 23,10 17,10"></polyline>
                <polyline points="1,20 1,14 7,14"></polyline>
                <path d="M20.49,9A9,9,0,0,0,5.64,5.64L1,10m22,4L18.36,18.36A9,9,0,0,1,3.51,15"></path>
              </svg>
              Retry
            </button>
          </div>

          <!-- Error Message -->
          <div class="error-message" *ngIf="exportRun.status === 'failed' && exportRun.error_message">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            {{ exportRun.error_message }}
          </div>

          <!-- File Info -->
          <div class="file-info" *ngIf="exportRun.status === 'success' && exportRun.file_size">
            <span class="file-size">{{ formatFileSize(exportRun.file_size) }}</span>
            <span class="row-count" *ngIf="exportRun.row_count">{{ exportRun.row_count }} rows</span>
          </div>
        </div>
      </div>

      <!-- Export History -->
      <div class="export-history" *ngIf="showHistory">
        <h4>Recent Exports</h4>
        <div class="history-list">
          <!-- History items would go here -->
        </div>
      </div>
    </div>

    <div class="export-panel-footer">
      <button class="secondary-button" (click)="onClose()">Close</button>
      <button class="primary-button" (click)="onViewHistory()" *ngIf="!showHistory">
        View History
      </button>
    </div>
  </div>
</div>
