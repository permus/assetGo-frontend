<div class="modal-overlay" (click)="onCancel()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <h2 class="modal-title">Receive Items</h2>
      <button class="close-btn" (click)="onCancel()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Error Display -->
      <div *ngIf="error" class="error-banner">
        <div class="error-icon">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <div class="error-content">
          <h4 class="error-title">Error Receiving Items</h4>
          <p class="error-message">{{ error }}</p>
          
          <!-- Field-specific errors -->
          <div *ngIf="errors" class="field-errors">
            <div *ngIf="getBackendError('items')" class="field-error">
              <strong>Items:</strong> {{ getBackendError('items') }}
            </div>
            <div *ngIf="getBackendError('location_id')" class="field-error">
              <strong>Location:</strong> {{ getBackendError('location_id') }}
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="purchaseOrder" class="po-summary">
        <h3 class="section-title">Purchase Order Summary</h3>
        <div class="summary-grid">
          <div class="summary-item">
            <label>PO Number</label>
            <span>{{ purchaseOrder.po_number }}</span>
          </div>
          <div class="summary-item">
            <label>Supplier</label>
            <span>{{ purchaseOrder.supplier?.name || 'Unknown Supplier' }}</span>
          </div>
          <div class="summary-item">
            <label>Total Items</label>
            <span>{{ purchaseOrder.items?.length || 0 }}</span>
          </div>
          <div class="summary-item">
            <label>Total Value</label>
            <span>{{ formatCurrency(purchaseOrder.total) }}</span>
          </div>
        </div>
      </div>

      <form [formGroup]="receiveForm" (ngSubmit)="onSubmit()" class="receive-form">
        <!-- Location Selection -->
        <div class="form-section">
          <h3 class="section-title">Receiving Location</h3>
          <div class="form-field">
            <label for="location" class="field-label">Location *</label>
            <select id="location" formControlName="location_id" class="form-select" [class.error]="errors.location_id">
              <option value="">Select a location</option>
              <option *ngFor="let location of locations" [value]="location.id">
                {{ location.name }}
              </option>
            </select>
            <div class="error-message" *ngIf="getFieldError('location_id')">
              {{ getFieldError('location_id') }}
            </div>
            <div class="error-message" *ngIf="getBackendError('location_id')">
              {{ getBackendError('location_id') }}
            </div>
          </div>
        </div>

        <!-- Items to Receive -->
        <div class="form-section">
          <h3 class="section-title">Items to Receive</h3>
          <div *ngIf="getBackendError('items')" class="error-message items-error">
            <strong>Items Error:</strong> {{ getBackendError('items') }}
          </div>
          <div *ngIf="itemsArray.length === 0" class="error-message">
            <strong>No items available to receive.</strong> All items from this purchase order have already been received.
          </div>
          
          <div formArrayName="items" class="items-container" [class.has-error]="getBackendError('items') && itemsArray.length > 0" *ngIf="itemsArray.length > 0">
            <div *ngFor="let item of itemsArray.controls; let i = index" [formGroupName]="i" class="item-row">
              <div class="item-header">
                <h4 class="item-title">{{ item.get('part_number')?.value }} 21123</h4>
                <div class="item-summary">
                  <span class="ordered">Ordered: {{ item.get('ordered_qty')?.value }}</span>
                  <span class="received">Received: {{ item.get('received_qty')?.value }}</span>
                  <span class="remaining">Remaining: {{ item.get('remaining_qty')?.value }}</span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-field">
                  <label [for]="'receive_qty_' + i" class="field-label">Receive Quantity *</label>
                  <input
                    type="number"
                    [id]="'receive_qty_' + i"
                    formControlName="receive_qty"
                    class="form-input"
                    [min]="1"
                    [max]="item.get('remaining_qty')?.value">
                  <div class="error-message" *ngIf="getArrayFieldError(i, 'receive_qty')">
                    {{ getArrayFieldError(i, 'receive_qty') }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
          <h3 class="section-title">Additional Information</h3>
          <div class="form-row">
            <div class="form-field">
              <label for="reference" class="field-label">Reference</label>
              <input
                type="text"
                id="reference"
                formControlName="reference"
                class="form-input"
                placeholder="e.g., Delivery Note DN-001">
            </div>
          </div>

          <div class="form-row">
            <div class="form-field full-width">
              <label for="notes" class="field-label">Notes</label>
              <textarea
                id="notes"
                formControlName="notes"
                rows="3"
                class="form-textarea"
                placeholder="Add any additional notes about this delivery..."></textarea>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="onCancel()">
        Cancel
      </button>
      <button
        type="submit"
        class="btn btn-primary"
        (click)="onSubmit()"
        [disabled]="!receiveForm.valid || loading">
        <span *ngIf="loading">Receiving...</span>
        <span *ngIf="!loading">Receive Items</span>
      </button>
    </div>
  </div>
</div>


