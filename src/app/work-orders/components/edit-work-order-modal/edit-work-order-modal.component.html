<div class="modal-overlay" *ngIf="isOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <h2 class="modal-title">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        Edit Work Order
      </h2>
      <button class="close-btn" (click)="closeModal()" type="button">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Loading state while form is being initialized -->
      <div *ngIf="!isFormReady" class="loading-state">
        <div class="spinner"></div>
        <p>Loading form...</p>
      </div>

      <form *ngIf="isFormReady" [formGroup]="editForm" (ngSubmit)="onSubmit()" class="edit-form">
        <!-- Basic Information -->
        <div class="form-section">
          <h3 class="section-title">Basic Information</h3>

          <div class="form-row">
            <div class="form-group">
              <label for="title" class="form-label">Title *</label>
              <input
                id="title"
                type="text"
                formControlName="title"
                class="form-input"
                placeholder="Enter work order title"
                [class.error]="isFieldInvalid('title')"
              />
              <div *ngIf="isFieldInvalid('title')" class="error-message">
                {{ getFieldError('title') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="status" class="form-label">Status *</label>
              <select
                id="status"
                formControlName="status_id"
                class="form-select capitalize"
                [class.error]="isFieldInvalid('status_id')"
              >
                <option value="">Select status</option>
                @for (status of statusOptions;track status.id) {
                  <option value="{{ status.id }}">{{ status.name }}</option>
                }
              </select>
              <div *ngIf="isFieldInvalid('status_id')" class="error-message">
                {{ getFieldError('status_id') }}
              </div>
            </div>

            <div class="form-group">
              <label for="priority" class="form-label">Priority *</label>
              <select
                id="priority"
                formControlName="priority_id"
                class="form-select capitalize"
                [class.error]="isFieldInvalid('priority_id')"
              >
                <option value="">Select Priority</option>
               @for (priority of priorityOptions;track priority) {
                <option value="{{ priority.id }}">{{ priority.name }}</option>
               }
              </select>
              <div *ngIf="isFieldInvalid('priority')" class="error-message">
                {{ getFieldError('priority') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="category" class="form-label">Category (Optional)</label>
              <select
                id="category"
                formControlName="category_id"
                class="form-select"
                [class.error]="isFieldInvalid('category_id')"
              >
                <option value="">Select Category</option>
                @for (category of categoryOptions;track category.id) {
                  <option value="{{ category.id }}">{{ category.name }}</option>
                }
              </select>
              <div *ngIf="isFieldInvalid('category_id')" class="error-message">
                {{ getFieldError('category_id') }}
              </div>
            </div>

            <div class="form-group" [class.error]="hasFieldError('due_date')">
              <label for="due_date" class="form-label">Due Date</label>
              <input
                id="due_date"
                type="date"
                formControlName="due_date"
                class="form-input"
                [class.error-input]="hasFieldError('due_date')"
              />
              <div *ngIf="hasFieldError('due_date')" class="error-message">
                {{ getFieldError('due_date') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group" [class.error]="hasFieldError('description')">
              <label for="description" class="form-label">Description</label>
              <textarea
                id="description"
                formControlName="description"
                class="form-textarea"
                placeholder="Enter work order description"
                rows="3"
                [class.error-input]="hasFieldError('description')"
              ></textarea>
              <div *ngIf="hasFieldError('description')" class="error-message">
                {{ getFieldError('description') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group" [class.error]="hasFieldError('estimated_hours')">
              <label for="estimated_hours" class="form-label">Estimated Hours</label>
              <input
                id="estimated_hours"
                type="number"
                formControlName="estimated_hours"
                class="form-input"
                placeholder="0.0"
                min="0"
                step="0.5"
                [class.error-input]="hasFieldError('estimated_hours')"
              />
              <div *ngIf="hasFieldError('estimated_hours')" class="error-message">
                {{ getFieldError('estimated_hours') }}
              </div>
            </div>

            <div class="form-group" [class.error]="hasFieldError('notes')">
              <label for="notes" class="form-label">Notes</label>
              <textarea
                id="notes"
                formControlName="notes"
                class="form-textarea"
                placeholder="Additional notes or instructions"
                rows="3"
                [class.error-input]="hasFieldError('notes')"
              ></textarea>
              <div *ngIf="hasFieldError('notes')" class="error-message">
                {{ getFieldError('notes') }}
              </div>
            </div>
          </div>
        </div>

        <!-- Assignment & Asset -->
        <div class="form-section">
          <h3 class="section-title">Assignment & Asset</h3>

          <div class="form-row">
            <div class="form-group" [class.error]="hasFieldError('asset_id')">
              <label for="asset_id" class="form-label">Asset</label>
              <select
                (change)="onAssetChange($event)"
                id="asset_id"
                formControlName="asset_id"
                class="form-select"
                [class.error-input]="hasFieldError('asset_id')"
              >
                <option value="">Select Asset</option>
                <option *ngFor="let asset of assets" [value]="asset.id">
                  {{ asset.name }} ({{ asset.asset_id }})
                </option>
              </select>
              <div *ngIf="hasFieldError('asset_id')" class="error-message">
                {{ getFieldError('asset_id') }}
              </div>
            </div>

            <div class="form-group" [class.error]="hasFieldError('location_id')">
              <label for="location_id" class="form-label">Location</label>
              <select
                id="location_id"
                formControlName="location_id"
                class="form-select"
                [class.error-input]="hasFieldError('location_id')"
              >
                <option value="">Select Location</option>
                <option *ngFor="let location of locations" [value]="location.id">
                  {{ location.name }}
                </option>
              </select>
              <div *ngIf="hasFieldError('location_id')" class="error-message">
                {{ getFieldError('location_id') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group" [class.error]="hasFieldError('assigned_to')">
              <label for="assigned_to" class="form-label">Assign To Team Member (Optional)</label>
              <select
                id="assigned_to"
                formControlName="assigned_to"
                class="form-select"
                [class.error-input]="hasFieldError('assigned_to')"
              >
                <option value="">Select Assignee</option>
                <option *ngFor="let user of users" [value]="user.id">
                  {{ user.first_name }} {{ user.last_name }}
                </option>
              </select>
              <div *ngIf="hasFieldError('assigned_to')" class="error-message">
                {{ getFieldError('assigned_to') }}
              </div>
              <div class="field-help">
                <small>Select an existing team member to assign the work order to</small>
              </div>
            </div>
          </div>
        </div>


      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="onSubmit()"
        [disabled]="!canSubmit()"
      >
        <svg *ngIf="isSubmitting" class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        {{ isSubmitting ? 'Updating...' : 'Update Work Order' }}
      </button>
    </div>
  </div>
</div>
