import{a as g}from"./chunk-MEXLA3FU.js";import{F as m}from"./chunk-CNTUU5WV.js";import{V as o,Y as u,ba as p,g as i}from"./chunk-RHVXZUNF.js";import{a as c}from"./chunk-EQDQRRRY.js";var h=class a{constructor(e){this.http=e;this.loadUserFromStorage()}apiUrl=g.apiUrl;currentUserSubject=new i(null);currentUser$=this.currentUserSubject.asObservable();moduleAccessSubject=new i({});moduleAccess$=this.moduleAccessSubject.asObservable();permissionsSubject=new i({});permissions$=this.permissionsSubject.asObservable();servicesInitialized=!1;getAuthHeaders(){let e=this.getToken();return{headers:c({"Content-Type":"application/json"},e?{Authorization:`Bearer ${e}`}:{})}}register(e){return this.http.post(`${this.apiUrl}/register`,e,this.getAuthHeaders())}login(e){return this.http.post(`${this.apiUrl}/login`,e,{headers:{"Content-Type":"application/json"}}).pipe(o(t=>{t.success&&t.data?.token&&(this.setSession(t.data.token,t.data.user),t.data?.module_access&&(this.moduleAccessSubject.next(t.data.module_access),localStorage.setItem("module_access",JSON.stringify(t.data.module_access))),t.data?.permissions&&(this.permissionsSubject.next(t.data.permissions),localStorage.setItem("permissions",JSON.stringify(t.data.permissions))))}))}forgotPassword(e){return this.http.post(`${this.apiUrl}/forgot-password`,e,this.getAuthHeaders())}resetPassword(e){return this.http.post(`${this.apiUrl}/reset-password`,e,this.getAuthHeaders())}verifyEmail(e,t){return this.http.get(`${this.apiUrl}/email/verify/${e}/${t}`,this.getAuthHeaders())}resendVerification(e){return this.http.post(`${this.apiUrl}/email/resend`,e||{},this.getAuthHeaders())}getProfile(){return this.http.get(`${this.apiUrl}/profile`,this.getAuthHeaders())}logout(){return this.http.post(`${this.apiUrl}/logout`,{},this.getAuthHeaders()).pipe(o(()=>{this.clearSession()}))}logoutAll(){return this.http.post(`${this.apiUrl}/logout-all`,{}).pipe(o(()=>{this.clearSession()}))}isAuthenticated(){return!!localStorage.getItem("token")}getToken(){return localStorage.getItem("token")}getCurrentUser(){return this.currentUserSubject.value}getModuleAccess(){return this.moduleAccessSubject.value}getPermissions(){return this.permissionsSubject.value}hasModuleAccess(e){return this.getModuleAccess()[e]===!0}hasPermission(e,t){return this.getPermissions()[e]?.[t]===!0}setSession(e,t){localStorage.setItem("token",e),localStorage.setItem("user",JSON.stringify(t)),this.currentUserSubject.next(t)}clearSession(){localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("module_access"),localStorage.removeItem("permissions"),localStorage.removeItem("cached_company"),localStorage.removeItem("cached_preferences"),localStorage.removeItem("cached_modules"),localStorage.removeItem("cached_feature_flags"),this.currentUserSubject.next(null),this.moduleAccessSubject.next({}),this.permissionsSubject.next({}),this.servicesInitialized=!1}loadUserFromStorage(){let e=localStorage.getItem("token"),t=localStorage.getItem("user"),s=localStorage.getItem("module_access"),r=localStorage.getItem("permissions");if(e&&t)try{let l=JSON.parse(t);if(this.currentUserSubject.next(l),s){let n=JSON.parse(s);this.moduleAccessSubject.next(n)}if(r){let n=JSON.parse(r);this.permissionsSubject.next(n)}}catch{this.clearSession()}}updateCurrentUser(e){this.currentUserSubject.next(e),localStorage.setItem("user",JSON.stringify(e))}initializeAppServices(e,t,s){this.servicesInitialized||(this.servicesInitialized=!0,t?t.initialize().subscribe({next:r=>{console.log("[AuthService] Preferences loaded and applied",r),e&&e.refreshFromServer().subscribe({error:()=>{}})},error:()=>{e&&e.refreshFromServer().subscribe({error:()=>{}})}}):e&&e.refreshFromServer().subscribe({error:()=>{}}),s&&s.listModules().subscribe({error:()=>{}}))}static \u0275fac=function(t){return new(t||a)(p(m))};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};export{h as a};
