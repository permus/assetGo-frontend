import{a as m}from"./chunk-47ABMRM7.js";import{F as d}from"./chunk-SXJTW2OO.js";import{U as i,X as p,ba as u,c as n,g as f}from"./chunk-XGV57TRJ.js";import{a as s,b as l}from"./chunk-EQDQRRRY.js";var h=class o{http=u(d);apiUrl=m.apiUrl;preferencesSubject=new f({email_notifications:!0,push_notifications:!0,maintenance_alerts:!0,work_order_updates:!0,dashboard_layout:"grid",items_per_page:20,auto_refresh:!1,compact_view:!1,show_avatars:!0,dark_mode:!1});preferences$=this.preferencesSubject.asObservable();constructor(){}initialize(){return new n(t=>{this.syncFromBackend().subscribe({next:e=>{if(e?.success&&e?.data){let r=e.data,a=s(s({},this.preferencesSubject.value),r);this.preferencesSubject.next(a),this.applyPreferences(a),localStorage.setItem("app.preferences",JSON.stringify(a)),t.next(a),t.complete()}else this.loadFromLocalStorage(),t.next(this.preferencesSubject.value),t.complete()},error:e=>{this.loadFromLocalStorage(),t.next(this.preferencesSubject.value),t.complete()}})})}loadFromLocalStorage(){let t=localStorage.getItem("app.preferences");if(t)try{let e=JSON.parse(t);this.preferencesSubject.next(s(s({},this.preferencesSubject.value),e)),this.applyPreferences(e)}catch(e){console.error("Failed to load preferences:",e)}}getPreferences(){return this.preferencesSubject.value}updatePreferences(t){let e=s(s({},this.preferencesSubject.value),t);this.preferencesSubject.next(e),localStorage.setItem("app.preferences",JSON.stringify(e)),this.applyPreferences(e)}applyPreferences(t){t.language&&document.documentElement.setAttribute("lang",t.language),t.rtl?document.documentElement.setAttribute("dir","rtl"):document.documentElement.setAttribute("dir","ltr"),t.dark_mode===!0?(document.documentElement.classList.add("dark"),document.body.classList.add("dark")):(document.documentElement.classList.remove("dark"),document.body.classList.remove("dark")),t.compact_view?document.documentElement.classList.add("compact-mode"):document.documentElement.classList.remove("compact-mode")}get(t){return this.preferencesSubject.value[t]}set(t,e){let r=l(s({},this.preferencesSubject.value),{[t]:e});this.preferencesSubject.next(r),localStorage.setItem("app.preferences",JSON.stringify(r)),this.applyPreferences(r)}setAndSave(t,e){let r=l(s({},this.preferencesSubject.value),{[t]:e});return this.preferencesSubject.next(r),localStorage.setItem("app.preferences",JSON.stringify(r)),this.applyPreferences(r),this.saveToBackend(r).pipe(i(a=>{if(a?.success&&a?.data){localStorage.setItem("cached_preferences",JSON.stringify(a));let c=s(s({},r),a.data);this.preferencesSubject.next(c),this.applyPreferences(c)}}))}syncing=!1;syncFromBackend(){if(this.syncing)return new n(e=>{e.next({success:!0,data:this.preferencesSubject.value}),e.complete()});let t=localStorage.getItem("cached_preferences");if(t)try{let e=JSON.parse(t);return this.syncing=!0,this.http.get(`${this.apiUrl}/settings/preferences`).pipe(i(r=>{if(this.syncing=!1,r.success&&r.data){localStorage.setItem("cached_preferences",JSON.stringify(r));let a=r.data,c=s(s({},this.preferencesSubject.value),a);this.preferencesSubject.next(c),this.applyPreferences(c)}})).subscribe({error:()=>{this.syncing=!1}}),new n(r=>{r.next(e),r.complete()})}catch(e){console.error("Failed to parse cached preferences:",e),localStorage.removeItem("cached_preferences")}return this.syncing=!0,this.http.get(`${this.apiUrl}/settings/preferences`).pipe(i(e=>{this.syncing=!1,e.success&&e.data&&localStorage.setItem("cached_preferences",JSON.stringify(e))}))}saveToBackend(t){return this.http.put(`${this.apiUrl}/settings/preferences`,t)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=p({token:o,factory:o.\u0275fac,providedIn:"root"})};export{h as a};
