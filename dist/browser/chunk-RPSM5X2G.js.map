{
  "version": 3,
  "sources": ["src/app/settings/settings.service.ts", "src/app/core/services/currency.service.ts"],
  "sourcesContent": ["import { Injectable, inject } from '@angular/core';\r\nimport { BehaviorSubject, Observable } from 'rxjs';\r\nimport { map, tap } from 'rxjs/operators';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { environment } from '../../environments/environment';\r\n\r\nexport type ApiResponse<T> = { success: boolean; message?: string; data?: T };\r\n\r\nexport interface Company {\r\n  id: number;\r\n  name: string;\r\n  owner_id: number | string;\r\n  email?: string | null;\r\n  phone?: string | null;\r\n  address?: string | null;\r\n  industry?: string | null;\r\n  business_type?: string | null;\r\n  currency?: string | null;\r\n  settings?: Record<string, unknown> | null;\r\n  logo_url?: string | null;\r\n}\r\n\r\nexport interface ModuleItem {\r\n  id: number;\r\n  key: string;\r\n  display_name: string;\r\n  description?: string | null;\r\n  icon_name?: string | null;\r\n  route_path?: string | null;\r\n  sort_order: number;\r\n  is_system_module: boolean;\r\n  is_enabled: boolean;\r\n}\r\n\r\nexport interface Preferences {\r\n  language?: string;\r\n  rtl?: boolean;\r\n  date_format?: string;\r\n  time_format?: string;\r\n  number_format?: string;\r\n  timezone?: string;\r\n  // Notification preferences\r\n  email_notifications?: boolean;\r\n  push_notifications?: boolean;\r\n  maintenance_alerts?: boolean;\r\n  work_order_updates?: boolean;\r\n  // Display\r\n  dashboard_layout?: 'grid' | 'list';\r\n  items_per_page?: number;\r\n  auto_refresh?: boolean;\r\n  compact_view?: boolean;\r\n  show_avatars?: boolean;\r\n  // Accessibility\r\n  dark_mode?: boolean;\r\n}\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class SettingsService {\r\n  private http = inject(HttpClient);\r\n  private base = environment.apiUrl;\r\n  // Stream broadcasting module enablement state\r\n  private modulesEnabled$ = new BehaviorSubject<Record<string, boolean>>({});\r\n  private modulesLoaded = false;\r\n  private modulesLoading = false;\r\n\r\n  // Company\r\n  getCompany() {\r\n    return this.http.get<ApiResponse<{ company: Company }>>(`${this.base}/company`);\r\n  }\r\n  updateCompany(payload: Partial<Company>) {\r\n    return this.http.put<ApiResponse<{ company: Company }>>(`${this.base}/company`, payload);\r\n  }\r\n  updateCurrency(currency: string) {\r\n    return this.http.put<ApiResponse<{ company: Company }>>(`${this.base}/settings/currency`, { currency });\r\n  }\r\n  uploadCompanyLogo(file: File) {\r\n    const fd = new FormData();\r\n    fd.append('logo', file);\r\n    return this.http.post<ApiResponse<{ logo_url: string; company: Company }>>(\r\n      `${this.base}/settings/company/logo`, fd\r\n    );\r\n  }\r\n\r\n  // Modules\r\n  listModules() {\r\n    // Prevent multiple simultaneous requests\r\n    if (this.modulesLoading) {\r\n      return this.modulesEnabled$.asObservable().pipe(\r\n        map(() => ({ success: true, data: { modules: [] } } as ApiResponse<{ modules: ModuleItem[] }>))\r\n      );\r\n    }\r\n\r\n    this.modulesLoading = true;\r\n    return this.http\r\n      .get<ApiResponse<{ modules: ModuleItem[] }>>(`${this.base}/settings/modules`)\r\n      .pipe(tap(res => {\r\n        this.pushModulesEnabled(res?.data?.modules || []);\r\n        this.modulesLoaded = true;\r\n        this.modulesLoading = false;\r\n      }));\r\n  }\r\n  enableModule(moduleId: number) {\r\n    return this.http\r\n      .post<ApiResponse<{ module_id: number }>>(`${this.base}/settings/modules/${moduleId}/enable`, {})\r\n      .pipe(tap(() => this.refreshModulesEnabled().subscribe()));\r\n  }\r\n  disableModule(moduleId: number) {\r\n    return this.http\r\n      .post<ApiResponse<{ module_id: number }>>(`${this.base}/settings/modules/${moduleId}/disable`, {})\r\n      .pipe(tap(() => this.refreshModulesEnabled().subscribe()));\r\n  }\r\n\r\n  // Preferences\r\n  getPreferences() {\r\n    return this.http.get<ApiResponse<Preferences>>(`${this.base}/settings/preferences`);\r\n  }\r\n  updatePreferences(prefs: Preferences) {\r\n    return this.http.put<ApiResponse<Preferences>>(`${this.base}/settings/preferences`, prefs);\r\n  }\r\n\r\n  // ----- Modules enabled stream helpers -----\r\n  getModulesEnabled$(): Observable<Record<string, boolean>> {\r\n    // Auto-load modules on first access if not already loaded\r\n    if (!this.modulesLoaded && !this.modulesLoading) {\r\n      const currentValue = this.modulesEnabled$.value;\r\n      // Only load if BehaviorSubject is empty (no cached data)\r\n      if (Object.keys(currentValue).length === 0) {\r\n        this.modulesLoading = true;\r\n        this.listModules().subscribe({\r\n          next: () => {\r\n            this.modulesLoaded = true;\r\n            this.modulesLoading = false;\r\n          },\r\n          error: () => {\r\n            this.modulesLoading = false;\r\n            // Keep modulesLoaded as false so it can retry on next access\r\n          }\r\n        });\r\n      } else {\r\n        // Data already exists in BehaviorSubject, mark as loaded\r\n        this.modulesLoaded = true;\r\n      }\r\n    }\r\n    return this.modulesEnabled$.asObservable();\r\n  }\r\n\r\n  refreshModulesEnabled() {\r\n    this.modulesLoaded = false;\r\n    return this.listModules();\r\n  }\r\n\r\n  private pushModulesEnabled(list: ModuleItem[]): void {\r\n    const map: Record<string, boolean> = {};\r\n    for (const m of list) map[m.key] = !!m.is_enabled;\r\n    this.modulesEnabled$.next(map);\r\n  }\r\n}\r\n\r\n\r\n", "import { Injectable, inject } from '@angular/core';\r\nimport { BehaviorSubject, Observable } from 'rxjs';\r\nimport { map, tap } from 'rxjs/operators';\r\nimport { SettingsService } from '../../settings/settings.service';\r\n\r\nexport type CurrencyCode = 'USD' | 'AED' | string;\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class CurrencyService {\r\n  private readonly settings = inject(SettingsService);\r\n  private readonly currency$ = new BehaviorSubject<CurrencyCode>('USD');\r\n  private refreshing = false;\r\n  \r\n  private readonly currencySymbols: Record<string, string> = {\r\n    'USD': '$',\r\n    'AED': 'د.إ',\r\n  };\r\n\r\n  // Load from server and broadcast\r\n  refreshFromServer(): Observable<CurrencyCode> {\r\n    // Prevent multiple simultaneous requests\r\n    if (this.refreshing) {\r\n      return this.currency$.asObservable().pipe(\r\n        map(code => code)\r\n      );\r\n    }\r\n\r\n    this.refreshing = true;\r\n    return this.settings.getCompany().pipe(\r\n      map(res => ((res?.data?.company?.currency || 'USD') as CurrencyCode)),\r\n      tap(code => {\r\n        this.currency$.next(code);\r\n        this.refreshing = false;\r\n      })\r\n    );\r\n  }\r\n\r\n  get$(): Observable<CurrencyCode> {\r\n    return this.currency$.asObservable();\r\n  }\r\n\r\n  getCurrent(): CurrencyCode {\r\n    return this.currency$.getValue();\r\n  }\r\n\r\n  getSymbol(): string {\r\n    const code = this.getCurrent();\r\n    return this.currencySymbols[code] || code;\r\n  }\r\n\r\n  // Helper to format amounts consistently\r\n  format(amount: number | string | null | undefined): string {\r\n    const num = Number(amount ?? 0);\r\n    if (!isFinite(num)) return `${this.getSymbol()}0.00`;\r\n    return `${this.getSymbol()}${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n  }\r\n}\r\n\r\n\r\n"],
  "mappings": "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",
  "names": ["map"]
}
