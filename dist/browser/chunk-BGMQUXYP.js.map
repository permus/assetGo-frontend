{
  "version": 3,
  "sources": ["src/app/core/services/auth.service.ts"],
  "sourcesContent": ["import { Injectable, inject } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, BehaviorSubject } from 'rxjs';\r\nimport { tap } from 'rxjs/operators';\r\nimport { environment } from '../../../environments/environment';\r\n\r\nexport interface User {\r\n  id: number;\r\n  first_name: string;\r\n  last_name: string;\r\n  email: string;\r\n  email_verified_at?: string;\r\n  avatar?: string;\r\n  avatar_url?: string;\r\n  user_type: string;\r\n  company_id: number;\r\n  company?: Company;\r\n}\r\n\r\nexport interface Company {\r\n  id: number;\r\n  name: string;\r\n  slug: string;\r\n  owner_id: number;\r\n  subscription_status: string;\r\n}\r\n\r\nexport interface AuthResponse {\r\n  success: boolean;\r\n  message: string;\r\n  data?: {\r\n    user: User;\r\n    company?: Company;\r\n    token: string;\r\n    token_type: string;\r\n    email_verified: boolean;\r\n    permissions?: Record<string, any>;\r\n    module_access?: Record<string, boolean>;\r\n  };\r\n  error?: string;\r\n  email_verified?: boolean;\r\n  user_id?: number;\r\n}\r\n\r\nexport interface RegisterRequest {\r\n  first_name: string;\r\n  last_name: string;\r\n  company_name: string;\r\n  email: string;\r\n  password: string;\r\n  password_confirmation: string;\r\n  user_type?: string;\r\n}\r\n\r\nexport interface LoginRequest {\r\n  email: string;\r\n  password: string;\r\n}\r\n\r\nexport interface ForgotPasswordRequest {\r\n  email: string;\r\n}\r\n\r\nexport interface ResetPasswordRequest {\r\n  token: string;\r\n  email: string;\r\n  password: string;\r\n  password_confirmation: string;\r\n}\r\n\r\nexport interface ResendVerificationRequest {\r\n  email?: string;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  private apiUrl = environment.apiUrl;\r\n  private currentUserSubject = new BehaviorSubject<User | null>(null);\r\n  public currentUser$ = this.currentUserSubject.asObservable();\r\n  \r\n  private moduleAccessSubject = new BehaviorSubject<Record<string, boolean>>({});\r\n  public moduleAccess$ = this.moduleAccessSubject.asObservable();\r\n  \r\n  private permissionsSubject = new BehaviorSubject<Record<string, any>>({});\r\n  public permissions$ = this.permissionsSubject.asObservable();\r\n\r\n  private servicesInitialized = false;\r\n\r\n  constructor(private http: HttpClient) {\r\n    this.loadUserFromStorage();\r\n  }\r\n  private getAuthHeaders(): { headers: { [header: string]: string } } {\r\n    const token = this.getToken();\r\n    return {\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        ...(token ? { 'Authorization': `Bearer ${token}` } : {})\r\n      }\r\n    };\r\n  }\r\n\r\n\r\n  register(data: RegisterRequest): Observable<AuthResponse> {\r\n    return this.http.post<AuthResponse>(`${this.apiUrl}/register`, data, this.getAuthHeaders());\r\n  }\r\n\r\n  login(data: LoginRequest): Observable<AuthResponse> {\r\n    return this.http.post<AuthResponse>(`${this.apiUrl}/login`, data, {headers: {\r\n        'Content-Type': 'application/json',\r\n      }})\r\n      .pipe(\r\n        tap(response => {\r\n          if (response.success && response.data?.token) {\r\n            this.setSession(response.data.token, response.data.user);\r\n            \r\n            // Store module access and permissions\r\n            if (response.data?.module_access) {\r\n              this.moduleAccessSubject.next(response.data.module_access);\r\n              localStorage.setItem('module_access', JSON.stringify(response.data.module_access));\r\n            }\r\n            \r\n            if (response.data?.permissions) {\r\n              this.permissionsSubject.next(response.data.permissions);\r\n              localStorage.setItem('permissions', JSON.stringify(response.data.permissions));\r\n            }\r\n            \r\n            // Note: App services will be initialized from login component\r\n            // to avoid circular dependency issues\r\n          }\r\n        })\r\n      );\r\n  }\r\n\r\n  forgotPassword(data: ForgotPasswordRequest): Observable<AuthResponse> {\r\n    return this.http.post<AuthResponse>(`${this.apiUrl}/forgot-password`, data, this.getAuthHeaders());\r\n  }\r\n\r\n  resetPassword(data: ResetPasswordRequest): Observable<AuthResponse> {\r\n    return this.http.post<AuthResponse>(`${this.apiUrl}/reset-password`, data, this.getAuthHeaders());\r\n  }\r\n\r\n  verifyEmail(id: string, hash: string): Observable<AuthResponse> {\r\n    return this.http.get<AuthResponse>(`${this.apiUrl}/email/verify/${id}/${hash}`, this.getAuthHeaders());\r\n  }\r\n\r\n  resendVerification(data?: ResendVerificationRequest): Observable<AuthResponse> {\r\n    return this.http.post<AuthResponse>(`${this.apiUrl}/email/resend`, data || {}, this.getAuthHeaders());\r\n  }\r\n\r\n  getProfile(): Observable<AuthResponse> {\r\n    return this.http.get<AuthResponse>(`${this.apiUrl}/profile`, this.getAuthHeaders());\r\n  }\r\n\r\n  logout(): Observable<AuthResponse> {\r\n    return this.http.post<AuthResponse>(`${this.apiUrl}/logout`, {}, this.getAuthHeaders())\r\n      .pipe(\r\n        tap(() => {\r\n          this.clearSession();\r\n        })\r\n      );\r\n  }\r\n\r\n  logoutAll(): Observable<AuthResponse> {\r\n    return this.http.post<AuthResponse>(`${this.apiUrl}/logout-all`, {})\r\n      .pipe(\r\n        tap(() => {\r\n          this.clearSession();\r\n        })\r\n      );\r\n  }\r\n\r\n  isAuthenticated(): boolean {\r\n    return !!localStorage.getItem('token');\r\n  }\r\n\r\n  getToken(): string | null {\r\n    return localStorage.getItem('token');\r\n  }\r\n\r\n  getCurrentUser(): User | null {\r\n    return this.currentUserSubject.value;\r\n  }\r\n\r\n  getModuleAccess(): Record<string, boolean> {\r\n    return this.moduleAccessSubject.value;\r\n  }\r\n\r\n  getPermissions(): Record<string, any> {\r\n    return this.permissionsSubject.value;\r\n  }\r\n\r\n  hasModuleAccess(moduleKey: string): boolean {\r\n    const moduleAccess = this.getModuleAccess();\r\n    return moduleAccess[moduleKey] === true;\r\n  }\r\n\r\n  hasPermission(module: string, action: string): boolean {\r\n    const permissions = this.getPermissions();\r\n    return permissions[module]?.[action] === true;\r\n  }\r\n\r\n  private setSession(token: string, user: User): void {\r\n    localStorage.setItem('token', token);\r\n    localStorage.setItem('user', JSON.stringify(user));\r\n    this.currentUserSubject.next(user);\r\n  }\r\n\r\n  private clearSession(): void {\r\n    localStorage.removeItem('token');\r\n    localStorage.removeItem('user');\r\n    localStorage.removeItem('module_access');\r\n    localStorage.removeItem('permissions');\r\n    this.currentUserSubject.next(null);\r\n    this.moduleAccessSubject.next({});\r\n    this.permissionsSubject.next({});\r\n    // Reset services initialization flag so they can be initialized again on next login\r\n    this.servicesInitialized = false;\r\n  }\r\n\r\n  private loadUserFromStorage(): void {\r\n    const token = localStorage.getItem('token');\r\n    const userStr = localStorage.getItem('user');\r\n    const moduleAccessStr = localStorage.getItem('module_access');\r\n    const permissionsStr = localStorage.getItem('permissions');\r\n\r\n    if (token && userStr) {\r\n      try {\r\n        const user = JSON.parse(userStr);\r\n        this.currentUserSubject.next(user);\r\n        \r\n        // Load module access and permissions from storage\r\n        if (moduleAccessStr) {\r\n          const moduleAccess = JSON.parse(moduleAccessStr);\r\n          this.moduleAccessSubject.next(moduleAccess);\r\n        }\r\n        \r\n        if (permissionsStr) {\r\n          const permissions = JSON.parse(permissionsStr);\r\n          this.permissionsSubject.next(permissions);\r\n        }\r\n      } catch (error) {\r\n        this.clearSession();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the current user data (used when profile is updated)\r\n   */\r\n  public updateCurrentUser(user: User): void {\r\n    this.currentUserSubject.next(user);\r\n    localStorage.setItem('user', JSON.stringify(user));\r\n  }\r\n\r\n  /**\r\n   * Initialize app services after login (currency, preferences, modules)\r\n   * This is called automatically after successful login\r\n   * Services are injected from the component that calls this\r\n   */\r\n  public initializeAppServices(\r\n    currencyService?: any,\r\n    preferencesService?: any,\r\n    settingsService?: any\r\n  ): void {\r\n    // Prevent multiple initializations\r\n    if (this.servicesInitialized) {\r\n      return;\r\n    }\r\n    this.servicesInitialized = true;\r\n\r\n    // Initialize currency from server\r\n    if (currencyService) {\r\n      currencyService.refreshFromServer().subscribe({\r\n        error: () => {\r\n          // Silently fail - use defaults\r\n        }\r\n      });\r\n    }\r\n\r\n    // Load user preferences and apply to app\r\n    if (preferencesService) {\r\n      preferencesService.syncFromBackend().subscribe({\r\n        next: (response: any) => {\r\n          if (response.success && response.data) {\r\n            preferencesService.updatePreferences(response.data);\r\n          }\r\n        },\r\n        error: () => {\r\n          // Use defaults if sync fails\r\n        }\r\n      });\r\n    }\r\n\r\n    // Load modules\r\n    if (settingsService) {\r\n      settingsService.listModules().subscribe({\r\n        error: () => {\r\n          // Silently fail - modules will be loaded on first access via getModulesEnabled$()\r\n        }\r\n      });\r\n    }\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
