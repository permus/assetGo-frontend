import{a as y}from"./chunk-PSU7LOXN.js";import{a as b}from"./chunk-RF5RBUBT.js";import{a as h}from"./chunk-47ABMRM7.js";import{F as m}from"./chunk-SXJTW2OO.js";import{U as n,X as l,ba as a,c as i,g as u,r as c}from"./chunk-XGV57TRJ.js";var d=class s{http=a(m);base=h.apiUrl;modulesEnabled$=new u({});modulesLoaded=!1;modulesLoading=!1;getCompany(){let r=localStorage.getItem("cached_company");if(r)try{let e=JSON.parse(r);return new i(t=>{t.next(e),t.complete()})}catch(e){console.error("Failed to parse cached company data:",e),localStorage.removeItem("cached_company")}return this.http.get(`${this.base}/company`).pipe(n(e=>{e.success&&e.data&&localStorage.setItem("cached_company",JSON.stringify(e))}))}updateCompany(r){return this.http.put(`${this.base}/company`,r)}updateCurrency(r){return this.http.put(`${this.base}/settings/currency`,{currency:r})}uploadCompanyLogo(r){let e=new FormData;return e.append("logo",r),this.http.post(`${this.base}/settings/company/logo`,e)}listModules(){if(this.modulesLoading)return this.modulesEnabled$.asObservable().pipe(c(()=>({success:!0,data:{modules:[]}})));let r=localStorage.getItem("cached_modules");if(r)try{let e=JSON.parse(r);return this.pushModulesEnabled(e?.data?.modules||[]),this.modulesLoaded=!0,new i(t=>{t.next(e),t.complete()})}catch(e){console.error("Failed to parse cached modules:",e),localStorage.removeItem("cached_modules")}return this.modulesLoading=!0,this.http.get(`${this.base}/settings/modules`).pipe(n(e=>{this.pushModulesEnabled(e?.data?.modules||[]),this.modulesLoaded=!0,this.modulesLoading=!1,e.success&&e.data&&localStorage.setItem("cached_modules",JSON.stringify(e))}))}enableModule(r){return this.http.post(`${this.base}/settings/modules/${r}/enable`,{}).pipe(n(()=>this.refreshModulesEnabled().subscribe()))}disableModule(r){return this.http.post(`${this.base}/settings/modules/${r}/disable`,{}).pipe(n(()=>this.refreshModulesEnabled().subscribe()))}getPreferences(){return this.http.get(`${this.base}/settings/preferences`)}updatePreferences(r){return this.http.put(`${this.base}/settings/preferences`,r)}getModulesEnabled$(){if(!this.modulesLoaded&&!this.modulesLoading){let r=this.modulesEnabled$.value;Object.keys(r).length===0?(this.modulesLoading=!0,this.listModules().subscribe({next:()=>{this.modulesLoaded=!0,this.modulesLoading=!1},error:()=>{this.modulesLoading=!1}})):this.modulesLoaded=!0}return this.modulesEnabled$.asObservable()}refreshModulesEnabled(){return this.modulesLoaded=!1,this.listModules()}pushModulesEnabled(r){let e={};for(let t of r)e[t.key]=!!t.is_enabled;this.modulesEnabled$.next(e)}static \u0275fac=function(e){return new(e||s)};static \u0275prov=l({token:s,factory:s.\u0275fac,providedIn:"root"})};var g=class s{settings=a(d);prefsService=a(b);formatService=a(y);currency$=new u("USD");refreshing=!1;prefsSubscription;currencySymbols={USD:"$",AED:"\u062F.\u0625"};constructor(){this.prefsSubscription=this.prefsService.preferences$.subscribe(e=>{if(e?.currency){let t=e.currency.toUpperCase();this.currency$.getValue()!==t&&this.currency$.next(t)}});let r=this.prefsService.getPreferences();if(r?.currency){let e=r.currency.toUpperCase();this.currency$.next(e)}}ngOnDestroy(){this.prefsSubscription&&this.prefsSubscription.unsubscribe()}refreshFromServer(){if(this.refreshing)return this.currency$.asObservable().pipe(c(t=>t));let r=this.prefsService.getPreferences();if(r?.currency){let t=r.currency;return this.currency$.next(t),new i(o=>{o.next(t),o.complete()})}let e=localStorage.getItem("cached_company");if(e)try{let o=JSON.parse(e)?.data?.company?.currency||"USD";return this.currency$.next(o),new i(p=>{p.next(o),p.complete()})}catch(t){console.error("Failed to parse cached company data in currency service:",t),localStorage.removeItem("cached_company")}return this.refreshing=!0,this.settings.getCompany().pipe(c(t=>t?.data?.company?.currency||"USD"),n(t=>{this.currency$.next(t),this.refreshing=!1}))}setCurrency(r){this.currency$.next(r)}get$(){return this.currency$.asObservable()}getCurrent(){return this.currency$.getValue()}getSymbol(){let r=this.getCurrent();return this.currencySymbols[r]||r}format(r){let e=Number(r??0);return isFinite(e)?`${this.getSymbol()}${this.formatService.formatNumber(e,2)}`:`${this.getSymbol()}${this.formatService.formatNumber(0,2)}`}static \u0275fac=function(e){return new(e||s)};static \u0275prov=l({token:s,factory:s.\u0275fac,providedIn:"root"})};export{d as a,g as b};
