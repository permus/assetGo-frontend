import{a as y}from"./chunk-UG3FJGKH.js";import{a as f}from"./chunk-EVW3I7EW.js";import{a as b}from"./chunk-MEXLA3FU.js";import{E as g}from"./chunk-EETQBYPR.js";import{U as n,X as d,ba as i,c as a,g as u,r as c}from"./chunk-PPNYJFN7.js";var m=class o{http=i(g);base=b.apiUrl;modulesEnabled$=new u({});modulesLoaded=!1;modulesLoading=!1;getCompany(){let t=localStorage.getItem("cached_company");if(t)try{let e=JSON.parse(t);return new a(r=>{r.next(e),r.complete()})}catch(e){console.error("Failed to parse cached company data:",e),localStorage.removeItem("cached_company")}return this.http.get(`${this.base}/company`).pipe(n(e=>{e.success&&e.data&&localStorage.setItem("cached_company",JSON.stringify(e))}))}updateCompany(t){return this.http.put(`${this.base}/company`,t)}updateCurrency(t){return this.http.put(`${this.base}/settings/currency`,{currency:t})}uploadCompanyLogo(t){let e=new FormData;return e.append("logo",t),this.http.post(`${this.base}/settings/company/logo`,e)}listModules(t=!1){if(this.modulesLoading&&!t)return this.modulesEnabled$.asObservable().pipe(c(()=>({success:!0,data:{modules:[]}})));if(!t){let e=localStorage.getItem("cached_modules"),r=localStorage.getItem("cached_modules_timestamp");if(e&&r)try{let s=Date.now()-parseInt(r,10),l=30*1e3;if(s<l){let p=JSON.parse(e);return this.pushModulesEnabled(p?.data?.modules||[]),this.modulesLoaded=!0,new a(h=>{h.next(p),h.complete()})}else console.log("[SettingsService] Cache is stale, fetching fresh modules"),localStorage.removeItem("cached_modules"),localStorage.removeItem("cached_modules_timestamp")}catch(s){console.error("Failed to parse cached modules:",s),localStorage.removeItem("cached_modules"),localStorage.removeItem("cached_modules_timestamp")}}return this.modulesLoading=!0,this.http.get(`${this.base}/settings/modules`).pipe(n(e=>{this.pushModulesEnabled(e?.data?.modules||[]),this.modulesLoaded=!0,this.modulesLoading=!1,e.success&&e.data&&(localStorage.setItem("cached_modules",JSON.stringify(e)),localStorage.setItem("cached_modules_timestamp",Date.now().toString()))}))}enableModule(t){return this.http.post(`${this.base}/settings/modules/${t}/enable`,{}).pipe(n(()=>{this.refreshModulesEnabled().subscribe({next:()=>{},error:e=>{console.error("Failed to refresh modules after enable:",e)}})}))}disableModule(t){return this.http.post(`${this.base}/settings/modules/${t}/disable`,{}).pipe(n(()=>{this.refreshModulesEnabled().subscribe({next:()=>{},error:e=>{console.error("Failed to refresh modules after disable:",e)}})}))}getPreferences(){return this.http.get(`${this.base}/settings/preferences`)}updatePreferences(t){return this.http.put(`${this.base}/settings/preferences`,t)}getModulesEnabled$(){if(!this.modulesLoaded&&!this.modulesLoading){let t=this.modulesEnabled$.value;Object.keys(t).length===0?(this.modulesLoading=!0,this.listModules().subscribe({next:()=>{this.modulesLoaded=!0,this.modulesLoading=!1},error:()=>{this.modulesLoading=!1}})):this.modulesLoaded=!0}return this.modulesEnabled$.asObservable()}refreshModulesEnabled(){return this.modulesLoaded=!1,this.modulesLoading=!1,localStorage.removeItem("cached_modules"),localStorage.removeItem("cached_modules_timestamp"),this.listModules(!0)}pushModulesEnabled(t){let e={};for(let r of t)e[r.key]=!!r.is_enabled;this.modulesEnabled$.next(e)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=d({token:o,factory:o.\u0275fac,providedIn:"root"})};var S=class o{settings=i(m);prefsService=i(f);formatService=i(y);currency$=new u("USD");refreshing=!1;prefsSubscription;currencySymbols={USD:"$",AED:"\u062F.\u0625"};constructor(){this.prefsSubscription=this.prefsService.preferences$.subscribe(e=>{if(e?.currency){let r=e.currency.toUpperCase();this.currency$.getValue()!==r&&this.currency$.next(r)}});let t=this.prefsService.getPreferences();if(t?.currency){let e=t.currency.toUpperCase();this.currency$.next(e)}}ngOnDestroy(){this.prefsSubscription&&this.prefsSubscription.unsubscribe()}refreshFromServer(){if(this.refreshing)return this.currency$.asObservable().pipe(c(r=>r));let t=this.prefsService.getPreferences();if(t?.currency){let r=t.currency;return this.currency$.next(r),new a(s=>{s.next(r),s.complete()})}let e=localStorage.getItem("cached_company");if(e)try{let s=JSON.parse(e)?.data?.company?.currency||"USD";return this.currency$.next(s),new a(l=>{l.next(s),l.complete()})}catch(r){console.error("Failed to parse cached company data in currency service:",r),localStorage.removeItem("cached_company")}return this.refreshing=!0,this.settings.getCompany().pipe(c(r=>r?.data?.company?.currency||"USD"),n(r=>{this.currency$.next(r),this.refreshing=!1}))}setCurrency(t){this.currency$.next(t)}get$(){return this.currency$.asObservable()}getCurrent(){return this.currency$.getValue()}getSymbol(){let t=this.getCurrent();return this.currencySymbols[t]||t}format(t){let e=Number(t??0);return isFinite(e)?`${this.getSymbol()}${this.formatService.formatNumber(e,2)}`:`${this.getSymbol()}${this.formatService.formatNumber(0,2)}`}static \u0275fac=function(e){return new(e||o)};static \u0275prov=d({token:o,factory:o.\u0275fac,providedIn:"root"})};export{m as a,S as b};
