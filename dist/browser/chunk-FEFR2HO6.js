import{a as I}from"./chunk-BACLOCGF.js";import{a as $}from"./chunk-AS2LAICM.js";import{a as C}from"./chunk-MEXLA3FU.js";import{F as _}from"./chunk-CNTUU5WV.js";import{F as v,S as b,V as l,Y as m,c as a,ca as i,g as d,m as y,r as S,s as c}from"./chunk-RHVXZUNF.js";var p=class o{http=i(_);base=C.apiUrl;modulesEnabled$=new d({});modulesLoaded=!1;modulesLoading=!1;modulesLoadSubscription;getCompany(){let t=localStorage.getItem("cached_company");if(t)try{let e=JSON.parse(t);return new a(r=>{r.next(e),r.complete()})}catch(e){console.error("Failed to parse cached company data:",e),localStorage.removeItem("cached_company")}return this.http.get(`${this.base}/company`).pipe(l(e=>{e.success&&e.data&&localStorage.setItem("cached_company",JSON.stringify(e))}))}updateCompany(t){return this.http.put(`${this.base}/company`,t)}updateCurrency(t){return this.http.put(`${this.base}/settings/currency`,{currency:t})}uploadCompanyLogo(t){let e=new FormData;return e.append("logo",t),this.http.post(`${this.base}/settings/company/logo`,e)}listModules(t=!1){if(this.modulesLoading&&!t)return this.modulesEnabled$.asObservable().pipe(c(()=>({success:!0,data:{modules:[]}})));if(!t){let e=localStorage.getItem("cached_modules"),r=localStorage.getItem("cached_modules_timestamp");if(e&&r)try{let s=Date.now()-parseInt(r,10),n=30*1e3;if(s<n){let h=JSON.parse(e);return this.pushModulesEnabled(h?.data?.modules||[]),this.modulesLoaded=!0,new a(u=>{u.next(h),u.complete()})}else console.log("[SettingsService] Cache is stale, fetching fresh modules"),localStorage.removeItem("cached_modules"),localStorage.removeItem("cached_modules_timestamp")}catch(s){console.error("Failed to parse cached modules:",s),localStorage.removeItem("cached_modules"),localStorage.removeItem("cached_modules_timestamp")}}return this.modulesLoading=!0,this.http.get(`${this.base}/settings/modules`).pipe(S(1e4),l(e=>{this.pushModulesEnabled(e?.data?.modules||[]),this.modulesLoaded=!0,this.modulesLoading=!1,e.success&&e.data&&(localStorage.setItem("cached_modules",JSON.stringify(e)),localStorage.setItem("cached_modules_timestamp",Date.now().toString()))}),v(e=>(this.modulesLoading=!1,console.error("Failed to load modules:",e),y({success:!1,message:"Failed to load modules",data:{modules:[]}}))))}enableModule(t){return this.http.post(`${this.base}/settings/modules/${t}/enable`,{}).pipe(b(()=>this.refreshModulesEnabled()))}disableModule(t){return this.http.post(`${this.base}/settings/modules/${t}/disable`,{}).pipe(b(()=>this.refreshModulesEnabled()))}getPreferences(){return this.http.get(`${this.base}/settings/preferences`)}updatePreferences(t){return this.http.put(`${this.base}/settings/preferences`,t)}getModulesEnabled$(){let t=this.modulesEnabled$.value;if(Object.keys(t).length===0){let e=localStorage.getItem("cached_modules"),r=localStorage.getItem("cached_modules_timestamp");if(e&&r)try{let s=Date.now()-parseInt(r,10),n=30*1e3;if(s<n){let u=JSON.parse(e)?.data?.modules||[],g={};return u.forEach(f=>{g[f.key]=!!f.is_enabled}),this.modulesEnabled$.next(g),this.modulesLoaded=!0,this.modulesEnabled$.asObservable()}}catch(s){console.warn("[SettingsService] Failed to parse cached modules:",s)}}else return this.modulesLoaded=!0,this.modulesEnabled$.asObservable();return!this.modulesLoaded&&!this.modulesLoading&&(this.modulesLoading=!0,this.modulesLoadSubscription&&(this.modulesLoadSubscription.unsubscribe(),this.modulesLoadSubscription=void 0),this.modulesLoadSubscription=this.listModules(!1).subscribe({next:()=>{this.modulesLoaded=!0,this.modulesLoading=!1,this.modulesLoadSubscription=void 0},error:()=>{this.modulesLoading=!1,this.modulesLoadSubscription=void 0}})),this.modulesEnabled$.asObservable()}refreshModulesEnabled(){return this.modulesLoadSubscription&&(this.modulesLoadSubscription.unsubscribe(),this.modulesLoadSubscription=void 0),this.modulesLoaded=!1,this.modulesLoading=!1,localStorage.removeItem("cached_modules"),localStorage.removeItem("cached_modules_timestamp"),this.listModules(!0)}pushModulesEnabled(t){let e={};for(let r of t)e[r.key]=!!r.is_enabled;this.modulesEnabled$.next(e)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};var L=class o{settings=i(p);prefsService=i($);formatService=i(I);currency$=new d("USD");refreshing=!1;prefsSubscription;currencySymbols={USD:"$",AED:"\u062F.\u0625"};constructor(){this.prefsSubscription=this.prefsService.preferences$.subscribe(e=>{if(e?.currency){let r=e.currency.toUpperCase();this.currency$.getValue()!==r&&this.currency$.next(r)}});let t=this.prefsService.getPreferences();if(t?.currency){let e=t.currency.toUpperCase();this.currency$.next(e)}}ngOnDestroy(){this.prefsSubscription&&this.prefsSubscription.unsubscribe()}refreshFromServer(){if(this.refreshing)return this.currency$.asObservable().pipe(c(r=>r));let t=this.prefsService.getPreferences();if(t?.currency){let r=t.currency;return this.currency$.next(r),new a(s=>{s.next(r),s.complete()})}let e=localStorage.getItem("cached_company");if(e)try{let s=JSON.parse(e)?.data?.company?.currency||"USD";return this.currency$.next(s),new a(n=>{n.next(s),n.complete()})}catch(r){console.error("Failed to parse cached company data in currency service:",r),localStorage.removeItem("cached_company")}return this.refreshing=!0,this.settings.getCompany().pipe(c(r=>r?.data?.company?.currency||"USD"),l(r=>{this.currency$.next(r),this.refreshing=!1}))}setCurrency(t){this.currency$.next(t)}get$(){return this.currency$.asObservable()}getCurrent(){return this.currency$.getValue()}getSymbol(){let t=this.getCurrent();return this.currencySymbols[t]||t}format(t){let e=Number(t??0);return isFinite(e)?`${this.getSymbol()}${this.formatService.formatNumber(e,2)}`:`${this.getSymbol()}${this.formatService.formatNumber(0,2)}`}static \u0275fac=function(e){return new(e||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a,L as b};
