import{a as m}from"./chunk-MEXLA3FU.js";import{F as d}from"./chunk-CNTUU5WV.js";import{V as i,Y as f,c as a,ca as u,g as p}from"./chunk-RHVXZUNF.js";import{a as s,b as l}from"./chunk-EQDQRRRY.js";var h=class o{http=u(d);apiUrl=m.apiUrl;preferencesSubject=new p({email_notifications:!0,push_notifications:!0,maintenance_alerts:!0,work_order_updates:!0,dashboard_layout:"grid",items_per_page:20,auto_refresh:!1,compact_view:!1,show_avatars:!0,dark_mode:!1});preferences$=this.preferencesSubject.asObservable();constructor(){}initialize(){return new a(t=>{this.syncFromBackend().subscribe({next:e=>{if(e?.success&&e?.data){let r=e.data,c=s(s({},this.preferencesSubject.value),r);this.preferencesSubject.next(c),this.applyPreferences(c),localStorage.setItem("app.preferences",JSON.stringify(c)),t.next(c),t.complete()}else this.loadFromLocalStorage(),t.next(this.preferencesSubject.value),t.complete()},error:e=>{this.loadFromLocalStorage(),t.next(this.preferencesSubject.value),t.complete()}})})}loadFromLocalStorage(){let t=localStorage.getItem("app.preferences");if(t)try{let e=JSON.parse(t);this.preferencesSubject.next(s(s({},this.preferencesSubject.value),e)),this.applyPreferences(e)}catch(e){console.error("Failed to load preferences:",e)}}getPreferences(){return this.preferencesSubject.value}updatePreferences(t){let e=s(s({},this.preferencesSubject.value),t);this.preferencesSubject.next(e),localStorage.setItem("app.preferences",JSON.stringify(e)),this.applyPreferences(e)}applyPreferences(t){t.language&&document.documentElement.setAttribute("lang",t.language),t.rtl?document.documentElement.setAttribute("dir","rtl"):document.documentElement.setAttribute("dir","ltr"),t.dark_mode===!0?(document.documentElement.classList.add("dark"),document.body.classList.add("dark")):(document.documentElement.classList.remove("dark"),document.body.classList.remove("dark")),t.compact_view?document.documentElement.classList.add("compact-mode"):document.documentElement.classList.remove("compact-mode")}get(t){return this.preferencesSubject.value[t]}set(t,e){let r=l(s({},this.preferencesSubject.value),{[t]:e});this.preferencesSubject.next(r),localStorage.setItem("app.preferences",JSON.stringify(r)),this.applyPreferences(r)}setAndSave(t,e){let r=l(s({},this.preferencesSubject.value),{[t]:e});return this.preferencesSubject.next(r),localStorage.setItem("app.preferences",JSON.stringify(r)),this.applyPreferences(r),this.saveToBackend(r).pipe(i(c=>{if(c?.success&&c?.data){localStorage.setItem("cached_preferences",JSON.stringify(c));let n=s(s({},r),c.data);this.preferencesSubject.next(n),this.applyPreferences(n)}}))}syncing=!1;backgroundSyncSubscription;syncFromBackend(){if(this.syncing)return new a(e=>{e.next({success:!0,data:this.preferencesSubject.value}),e.complete()});let t=localStorage.getItem("cached_preferences");if(t)try{let e=JSON.parse(t);return!this.syncing&&!this.backgroundSyncSubscription&&(this.syncing=!0,this.backgroundSyncSubscription=this.http.get(`${this.apiUrl}/settings/preferences`).pipe(i(r=>{if(this.syncing=!1,this.backgroundSyncSubscription=void 0,r.success&&r.data){localStorage.setItem("cached_preferences",JSON.stringify(r));let c=r.data,n=s(s({},this.preferencesSubject.value),c);this.preferencesSubject.next(n),this.applyPreferences(n)}})).subscribe({error:()=>{this.syncing=!1,this.backgroundSyncSubscription=void 0}})),new a(r=>{r.next(e),r.complete()})}catch(e){console.error("Failed to parse cached preferences:",e),localStorage.removeItem("cached_preferences")}return this.syncing=!0,this.http.get(`${this.apiUrl}/settings/preferences`).pipe(i(e=>{this.syncing=!1,e.success&&e.data&&localStorage.setItem("cached_preferences",JSON.stringify(e))}))}saveToBackend(t){return this.http.put(`${this.apiUrl}/settings/preferences`,t)}static \u0275fac=function(e){return new(e||o)};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};export{h as a};
